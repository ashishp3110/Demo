Create  or replace  function ELBALANCE(VEMPID VARCHAR2,VSECTID VARCHAR2, TAKENFROM DATE) return NUMBER is
TRDAYS NUMBER;
TRDAYSEL NUMBER;
HDAYS NUMBER;
ELB NUMBER;
ELBD DATE;
JOIN DATE;
DID VARCHAR2(2);
VAPPDATE DATE;
ELD NUMBER;
ELBAL NUMBER;
BEGIN
 VAPPDATE:=TRUNC(TAKENFROM,'YYYY')-1;
  begin
  SELECT ELBALANCE,ELBALANCEDT,DOJOIN,TRIM(DGROUPID) INTO ELB,ELBD,JOIN,DID
  FROM EMPLOYEE
  WHERE EMPLOYEE.EMPID=VEMPID
  AND EMPLOYEE.SECTID=VSECTID;
 EXCEPTION
  when no_data_found then
  null;
  end;

   

   IF ELB IS NULL or ELB=0 THEN
    ELB:=0;
     ELBD :=JOIN;
  END IF;
  
   IF ELBD<JOIN THEN
    ELBD:=JOIN;
    ELB:=0;
  END IF;		

 begin
	ELD:=VAPPDATE-ELBD;
	IF ELD<0 THEN
	ELD:=0;
	END IF;	  
  EXCEPTION
   when no_data_found then
  ELD:=0;
  end;


	SELECT SUM(NVL(RDAYS,0)) INTO TRDAYS FROM LEAVEAPP
 	WHERE LTYPENAME IN ('ML','CL','ABS','LWP')
 	AND EMPID=VEMPID
     	AND SECTID=VSECTID
     	AND LTAKENFROM BETWEEN ELBD AND VAPPDATE;


	     SELECT SUM(NVL(RDAYS,0)) INTO TRDAYSEL FROM LEAVEAPP
	     WHERE LTYPENAME='EL'
	     AND EMPID=VEMPID
	     AND SECTID=VSECTID
	     AND TO_CHAR(LTAKENFROM,'RRRR')<=TO_CHAR(TAKENFROM,'RRRR')
	    AND LTAKENFROM<=TAKENFROM;

	    SELECT COUNT(HDATE) INTO HDAYS FROM HOLIDAYS
    	    WHERE HDATE BETWEEN ELBD AND VAPPDATE;


     TRDAYS:=NVL(TRDAYS,0)+NVL(TRDAYSEL,0);
     ELBAL:=NVL(ELB,0)+TRUNC((NVL(ELD,0)-NVL(HDAYS,0)-NVL(TRDAYS,0))/11);

 if DID IN('09','10','11','12','13','14','15','16','17','0','1','2','3','4','5','6','7') THEN
  ELBAL:=NVL(ELB,0)+TRUNC((NVL(ELD,0)-NVL(HDAYS,0)-NVL(TRDAYS,0))/22)-NVL(TRDAYSEL,0);
     ELSE
      ELBAL:=NVL(ELB,0)+TRUNC((NVL(ELD,0)-NVL(HDAYS,0)-NVL(TRDAYS,0))/11)-NVL(TRDAYSEL,0);
 END IF;


 RETURN ELBAL;
 EXCEPTION
  when no_data_found then
  null;
 END;
/
